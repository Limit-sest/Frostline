<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frostline</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f8ff;
      }

      canvas {
        display: block;
        cursor: crosshair;

        width: 600px;
        height: 600px;

        image-rendering: pixelated;
        image-rendering: crisp-edges;
        border: solid 2px black;
      }

      .icons {
        margin-top: 12px;
        display: flex;
        gap: 8px;
      }
      .icons button {
        border-radius: 0px;
        display: flex;
        justify-items: center;
        align-items: center;
        padding: 4px;
        cursor: pointer;
        background-color: hsl(0 0 90);
        border-color: hsl(0 0 70) hsl(0 0 50) hsl(0 0 70) hsl(0 0 50);
      }

      .icons button:hover {
        background-color: hsl(0 0 80);
        border-color: hsl(0 0 60) hsl(0 0 40) hsl(0 0 60) hsl(0 0 40);
      }

      .icons button.active {
        background-color: hsl(0 0 70);
        border-color: hsl(0 0 30) hsl(0 0 50) hsl(0 0 30) hsl(0 0 50);
      }

      .icons button img {
        image-rendering: pixelated;
        width: 32px;
        height: 32px;
      }
      .divider {
        height: 44px;
        border-left: solid dimgray 2px;
        margin: 0px 4px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div class="icons">
      <button id="pen" class="active">
        <img src="/assets/pen.png" alt="" />
      </button>
      <button id="rubber"><img src="/assets/rubber.png" alt="" /></button>
      <div class="divider"></div>
      <button id="size1"><img src="/assets/size1.png" alt="" /></button>
      <button id="size2"><img src="/assets/size2.png" alt="" /></button>
      <button id="size3"><img src="/assets/size3.png" alt="" /></button>
      <div class="divider"></div>
      <button id="color"><img src="/assets/color.png" alt="" /></button>
    </div>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
      const socket = io("localhost:3000");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      let drawBuffer = [];
      let willSendBuffer = false;
      const colors = ["#1A237E"];
      let currentColor = 0;

      const RESOLUTION = 200;
      canvas.width = RESOLUTION;
      canvas.height = RESOLUTION;

      ctx.imageSmoothingEnabled = false;
      ctx.fillStyle = colors[currentColor]; // draw color

      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;

      function drawPixel(x, y, color = currentColor, emit = false) {
        if (color === -1) {
          ctx.clearRect(x, y, 1, 1);
        } else {
          ctx.fillRect(x, y, 1, 1);
        }

        if (emit) {
          drawBuffer.push({ x: x, y: y, color: color });
          if (!willSendBuffer) {
            willSendBuffer = true;
            setTimeout(sendBuffer, 32);
          }
        }
      }

      function sendBuffer() {
        willSendBuffer = false;
        if (sendBuffer) socket.emit("drawBatch", drawBuffer);
        drawBuffer = [];
      }

      function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        return {
          x: Math.floor((evt.clientX - rect.left) * scaleX),
          y: Math.floor((evt.clientY - rect.top) * scaleY),
        };
      }

      socket.on("sync", (data) => {
        data.forEach((pixel) => {
          drawPixel(pixel.x, pixel.y, pixel.color);
        });
      });

      socket.on("draw", (pixel) => {
        drawPixel(pixel.x, pixel.y, pixel.color);
      });

      socket.on("drawBatch", (data) => {
        data.forEach((pixel) => {
          drawPixel(pixel.x, pixel.y, pixel.color);
        });
      });

      function drawPixelLine(x0, y0, x1, y1) {
        const dx = Math.abs(x1 - x0);
        const dy = Math.abs(y1 - y0);
        const sx = x0 < x1 ? 1 : -1;
        const sy = y0 < y1 ? 1 : -1;
        let err = dx - dy;

        while (true) {
          drawPixel(x0, y0, undefined, true);

          if (x0 === x1 && y0 === y1) break;
          const e2 = 2 * err;
          if (e2 > -dy) {
            err -= dy;
            x0 += sx;
          }
          if (e2 < dx) {
            err += dx;
            y0 += sy;
          }
        }
      }

      function startDrawing(e) {
        isDrawing = true;
        const pos = getMousePos(e);
        lastX = pos.x;
        lastY = pos.y;

        // Draw a single dot on click
        drawPixel(pos.x, pos.y, undefined, true);
      }

      function stopDrawing() {
        isDrawing = false;
      }

      function draw(e) {
        if (!isDrawing) return;

        const pos = getMousePos(e);
        drawPixelLine(lastX, lastY, pos.x, pos.y);

        lastX = pos.x;
        lastY = pos.y;
      }

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("mouseout", stopDrawing);

      // TOOLBAR
      const pen = document.getElementById("pen");
      const rubber = document.getElementById("rubber");
      const size1 = document.getElementById("size1");
      const size2 = document.getElementById("size2");
      const size3 = document.getElementById("size3");

      const tools = [pen, rubber];
      const sizes = [size1, size2, size3];

      function resetActive(group) {
        group.forEach((element) => {
          element.classList.remove("active");
          element.disabled = false;
        });
      }

      pen.addEventListener("click", () => {
        currentColor = 0;
        resetActive(tools);
        pen.classList.add("active");
        pen.disabled = true;
      });
      rubber.addEventListener("click", () => {
        currentColor = -1;
        resetActive(tools);
        rubber.classList.add("active");
        rubber.disabled = true;
      });
      size1.addEventListener("click", () => {
        currentColor = -1;
        resetActive(sizes);
        size1.classList.add("active");
        size1.disabled = true;
      });
      size2.addEventListener("click", () => {
        currentColor = -1;
        resetActive(sizes);
        size2.classList.add("active");
        size2.disabled = true;
      });
      size3.addEventListener("click", () => {
        currentColor = -1;
        resetActive(sizes);
        size3.classList.add("active");
        size3.disabled = true;
      });
    </script>
  </body>
</html>
